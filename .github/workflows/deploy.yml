name: Deploy Mirror (mtime)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SFTP_SERVER: ${{ secrets.SFTP_SERVER }}
      SFTP_USERNAME: ${{ secrets.SFTP_USERNAME }}
      SFTP_PORT: ${{ secrets.SFTP_PORT }}
      SFTP_REMOTE_PATH: ${{ secrets.SFTP_REMOTE_PATH }}
      SFTP_REMOTE_PUBLIC_PATH: ${{ secrets.SFTP_REMOTE_PUBLIC_PATH }}
      SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
      FTP_SERVER: ${{ secrets.FTP_SERVER }}
      FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
      FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
      FTP_PORT: ${{ secrets.FTP_PORT }}
      FTP_SERVER_DIR: ${{ secrets.FTP_SERVER_DIR }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Simplified deploy: pure mirror by name & time

      - name: Normalize remote path
        run: |
          set -e
          DIR="${SFTP_REMOTE_PATH:-$FTP_SERVER_DIR}"
          DIR="${DIR%/}/"
          echo "REMOTE_DIR_SLASH=${DIR}" >> $GITHUB_ENV
          echo "Remote dir: ${DIR}"

      - name: Mirror via SFTP (mtime)
        if: ${{ env.SFTP_SERVER != '' && env.SFTP_USERNAME != '' && env.SFTP_PASSWORD != '' }}
        uses: pressidium/lftp-mirror-action@v1
        with:
          host: ${{ env.SFTP_SERVER }}
          port: ${{ env.SFTP_PORT }}
          user: ${{ env.SFTP_USERNAME }}
          pass: ${{ env.SFTP_PASSWORD }}
          settings: 'sftp:auto-confirm=yes'
          onlyNewer: true
          restoreMTime: true
          parallel: 3
          localDir: './'
          remoteDir: ${{ env.REMOTE_DIR_SLASH }}
          reverse: true
          options: "--verbose --delete --no-empty-dirs --exclude-glob .git --exclude-glob .git/** --exclude-glob .github/** --exclude-glob node_modules/** --exclude-glob storage/framework/** --exclude-glob storage/logs/** --exclude-glob .env"

      - name: Mirror via FTP (mtime)
        if: ${{ env.FTP_SERVER != '' && env.FTP_USERNAME != '' && env.FTP_PASSWORD != '' }}
        uses: pressidium/lftp-mirror-action@v1
        with:
          host: ${{ env.FTP_SERVER }}
          port: ${{ env.FTP_PORT }}
          user: ${{ env.FTP_USERNAME }}
          pass: ${{ env.FTP_PASSWORD }}
          onlyNewer: true
          restoreMTime: true
          parallel: 3
          localDir: './'
          remoteDir: ${{ env.REMOTE_DIR_SLASH }}
          reverse: true
          options: "--verbose --delete --no-empty-dirs --exclude-glob .git --exclude-glob .git/** --exclude-glob .github/** --exclude-glob node_modules/** --exclude-glob storage/framework/** --exclude-glob storage/logs/** --exclude-glob .env"

      # Done

      # Preflight SSH (key)
      - name: Preflight SSH (key)
        if: ${{ env.SSH_PRIVATE_KEY != '' && env.SFTP_SERVER != '' }}
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.SFTP_SERVER }}
          username: ${{ env.SFTP_USERNAME }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          port: ${{ env.SFTP_PORT }}
          script: |
            set -e
            echo "Remote path: ${{ env.SFTP_REMOTE_PATH }}"
            ls -la ${{ env.SFTP_REMOTE_PATH }} || true

      # Preflight SSH (password)
      - name: Preflight SSH (password)
        if: ${{ env.SSH_PRIVATE_KEY == '' && env.SSH_PASSWORD != '' && env.SFTP_SERVER != '' }}
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.SFTP_SERVER }}
          username: ${{ env.SFTP_USERNAME }}
          password: ${{ env.SSH_PASSWORD }}
          port: ${{ env.SFTP_PORT }}
          script: |
            set -e
            echo "Remote path: ${{ env.SFTP_REMOTE_PATH }}"
            ls -la ${{ env.SFTP_REMOTE_PATH }} || true

      # Removed SamKirkland SFTP steps; using lftp mirror (mtime) only

      - name: Diagnose remote after upload (key)
        if: ${{ success() && env.SSH_PRIVATE_KEY != '' && env.SFTP_SERVER != '' }}
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.SFTP_SERVER }}
          username: ${{ env.SFTP_USERNAME }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          port: ${{ env.SFTP_PORT }}
          script: |
            set -e
            echo "Root listing:"
            ls -la ${{ env.SFTP_REMOTE_PATH }} | head -n 200 || true
            echo "Public listing:"
            ls -la ${{ env.REMOTE_PUBLIC_PATH }} | head -n 200 || true

      - name: Run post-deploy commands on server (Composer, cache, migrate) [key]
        if: ${{ success() && env.SSH_PRIVATE_KEY != '' }}
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.SFTP_SERVER }}
          username: ${{ env.SFTP_USERNAME }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          port: ${{ env.SFTP_PORT }}
          script: |
            set -e
            cd ${{ env.SFTP_REMOTE_PATH }}
            if command -v composer >/dev/null 2>&1; then
              composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader || true
            else
              echo "Composer tidak ditemukan di server. Jalankan manual via SSH: 'composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader'" || true
            fi
            php artisan config:clear || true
            php artisan cache:clear || true
            php artisan migrate --force || true
            php artisan db:seed --force || true

      # Removed SamKirkland FTP steps; using lftp mirror (mtime) only
