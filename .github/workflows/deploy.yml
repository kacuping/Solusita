name: Deploy to Hostinger via SFTP

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      SFTP_SERVER: ${{ secrets.SFTP_SERVER }}
      SFTP_USERNAME: ${{ secrets.SFTP_USERNAME }}
      SFTP_PORT: ${{ secrets.SFTP_PORT }}
      SFTP_REMOTE_PATH: ${{ secrets.SFTP_REMOTE_PATH }}
      SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer
          extensions: mbstring, bcmath, intl, gd, curl, zip
          coverage: none

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Composer dependencies (prod)
        run: |
          composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader

      - name: Install NPM dependencies and build assets
        run: |
          npm ci
          npm run build

      - name: Verify Vite manifest exists
        run: |
          if [ ! -f "./public/build/manifest.json" ]; then
            echo "ERROR: Vite manifest.json tidak ditemukan di ./public/build/. Pastikan proses build sukses dan output diarahkan ke public/build."
            exit 1
          else
            echo "OK: ./public/build/manifest.json ditemukan. Lanjut ke deploy."
          fi

      - name: Validate SFTP/SSH secrets presence
        run: |
          if [ -z "$SFTP_SERVER" ]; then echo "Missing GitHub Secret: SFTP_SERVER" && exit 1; fi
          if [ -z "$SFTP_USERNAME" ]; then echo "Missing GitHub Secret: SFTP_USERNAME" && exit 1; fi
          if [ -z "$SFTP_PORT" ]; then echo "Missing GitHub Secret: SFTP_PORT" && exit 1; fi
          if [ -z "$SFTP_REMOTE_PATH" ]; then echo "Missing GitHub Secret: SFTP_REMOTE_PATH" && exit 1; fi
          if [ -z "$SFTP_PASSWORD" ] && [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "Missing authentication: isi salah satu GitHub Secret: SFTP_PASSWORD atau SSH_PRIVATE_KEY"
            exit 1
          fi
          echo "OK: Secrets minimum terpenuhi. Lanjut ke langkah upload incremental via SFTP."

      # Upload incremental (hanya file yang berubah) via SFTP mirror dengan password
      - name: Upload only changed files (SFTP mirror - password)
        if: ${{ env.SFTP_PASSWORD != '' }}
        uses: pressidium/lftp-mirror-action@v1
        with:
          host: ${{ env.SFTP_SERVER }}
          remote-protocol: 'sftp'
          port: ${{ env.SFTP_PORT }}
          user: ${{ env.SFTP_USERNAME }}
          pass: ${{ env.SFTP_PASSWORD }}
          localDir: './'
          remoteDir: ${{ env.SFTP_REMOTE_PATH }}
          reverse: true
          # Opsi mirror: hanya kirim file lebih baru, hapus file lama di server agar identik
          options: "--only-newer --verbose --parallel=3 --no-empty-dirs --exclude-glob public/** --exclude-glob .git --exclude-glob .git/** --exclude-glob .github/** --exclude-glob node_modules/** --exclude-glob tests/** --exclude-glob storage/framework/** --exclude-glob storage/logs/** --exclude-glob .env"

      # Upload incremental via SFTP mirror dengan key (fallback jika tidak memakai password)
      - name: Upload only changed files (SFTP mirror - key)
        if: ${{ (env.SFTP_PASSWORD == '' || !env.SFTP_PASSWORD) && env.SSH_PRIVATE_KEY != '' }}
        uses: pressidium/lftp-mirror-action@v1
        env:
          LFTP_PASSWORD: ''
        with:
          host: ${{ env.SFTP_SERVER }}
          remote-protocol: 'sftp'
          port: ${{ env.SFTP_PORT }}
          user: ${{ env.SFTP_USERNAME }}
          # Catatan: untuk auth key-based, host harus menerima public key Anda via hPanel
          # Action ini terutama untuk password, sehingga disarankan mengisi SFTP_PASSWORD.
          # Jika host mendukung key-agent, Anda dapat menggunakan konfigurasi server.
          pass: ${{ env.LFTP_PASSWORD }}
          localDir: './'
          remoteDir: ${{ env.SFTP_REMOTE_PATH }}
          reverse: true
          options: "--only-newer --verbose --parallel=3 --no-empty-dirs --exclude-glob public/** --exclude-glob .git --exclude-glob .git/** --exclude-glob .github/** --exclude-glob node_modules/** --exclude-glob tests/** --exclude-glob storage/framework/** --exclude-glob storage/logs/** --exclude-glob .env"

      # Upload folder public secara terpisah (password)
      - name: Upload public directory (SFTP mirror - password)
        if: ${{ env.SFTP_PASSWORD != '' }}
        uses: pressidium/lftp-mirror-action@v1
        with:
          host: ${{ env.SFTP_SERVER }}
          remote-protocol: 'sftp'
          port: ${{ env.SFTP_PORT }}
          user: ${{ env.SFTP_USERNAME }}
          pass: ${{ env.SFTP_PASSWORD }}
          localDir: './public'
          remoteDir: ${{ endsWith(env.SFTP_REMOTE_PATH, '/public') && env.SFTP_REMOTE_PATH || format('{0}/public', env.SFTP_REMOTE_PATH) }}
          reverse: true
          options: "--only-newer --verbose --parallel=3 --no-empty-dirs --exclude-glob .env"

      # Upload folder public secara terpisah (key)
      - name: Upload public directory (SFTP mirror - key)
        if: ${{ (env.SFTP_PASSWORD == '' || !env.SFTP_PASSWORD) && env.SSH_PRIVATE_KEY != '' }}
        uses: pressidium/lftp-mirror-action@v1
        env:
          LFTP_PASSWORD: ''
        with:
          host: ${{ env.SFTP_SERVER }}
          remote-protocol: 'sftp'
          port: ${{ env.SFTP_PORT }}
          user: ${{ env.SFTP_USERNAME }}
          pass: ${{ env.LFTP_PASSWORD }}
          localDir: './public'
          remoteDir: ${{ endsWith(env.SFTP_REMOTE_PATH, '/public') && env.SFTP_REMOTE_PATH || format('{0}/public', env.SFTP_REMOTE_PATH) }}
          reverse: true
          options: "--only-newer --verbose --parallel=3 --no-empty-dirs --exclude-glob .env"

      - name: Run post-deploy commands on server (Composer, cache, migrate)
        if: ${{ success() && env.SSH_PRIVATE_KEY != '' }}
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.SFTP_SERVER }}
          username: ${{ env.SFTP_USERNAME }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          port: ${{ env.SFTP_PORT }}
          script: |
            set -e
            cd ${{ env.SFTP_REMOTE_PATH }}
            if command -v composer >/dev/null 2>&1; then
              composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader || true
            else
              echo "Composer tidak ditemukan di server. Jalankan manual via SSH: 'composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader'" || true
            fi
            php artisan config:clear || true
            php artisan cache:clear || true
            php artisan migrate --force || true
            php artisan db:seed --force || true
